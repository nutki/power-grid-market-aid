<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta charset="UTF-8" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="viewport" content="width=1024, user-scalable=no">
<link rel="shortcut icon" href="img/DEC.ico" />
<link rel="apple-touch-icon" href="img/DEC.jpg" />
<title>PG Auction</title>
<style>
@font-face {
font-family: Din1451Eng;
src: url('img/DIN1451Engschrift.ttf');
}
@font-face {
font-family: Waldmeister;
src: url('img/Waldmeister.ttf');
}
body {
font-family:Waldmeister, Helvetica, Arial;
width:1000px;
height:600px;
overflow:hidden;
margin:0px auto;
text-align:center;
font-size:24px;
background-color:#6e8c52;
position:relative;
}
div.header {
margin:4px 0px;
font-family:Din1451Eng, Helvetica, Arial;
font-size:48px;
}
div.panel {
width:1000px;
position:relative;
overflow:hidden;
}
div.card0 {
position:absolute;
width:186px;height:186px;
background-size: cover;
border:1px solid black;
border-radius: 10px;
}
div.card1 {
position:absolute;
width:184px;height:184px;
background-size: cover;
border:2px solid red;
border-radius: 10px;
}
div.card1:hover {
border:2px solid yellow;
}
div.market {
border:2px solid white;
position:static;
width:auto;
height:auto;
background-color:#d8dec2;
overflow:hidden;
}
div.button0 {
position:absolute;
background-color:#8e8e8e;
border-radius: 7px;
color:white;
}
div.button1 {
position:absolute;
background-color:#3e6e3e;
border-radius: 7px;
color:white;
}
div.button1:hover {
background-color:#a7bc95;
color:black;
}
div.phase0 {
position:absolute;
background-color:#8e8e8e;
border-radius: 7px;
color:white;
}
div.phase1 {
position:absolute;
background-color:blue;
border-radius: 7px;
color:white;
}
small {
font-size: 80%;
}
</style>
<script>

// #6e8c52 - dark green background
// #d8dec2 - light green background
// #3e6e3e - dark green banner
// #a7bc95 - light green banner

// Utility functions:

function RNG(seed) {
  this.m = 0x100000000;
  this.a = 1103515245;
  this.c = 12345;
  this.state = seed === undefined ? Math.floor(Math.random() * (this.m-1)) : seed;
}
RNG.prototype.nextInt = function() {
  this.state = (this.a * this.state + this.c) % this.m;
  return this.state;
}
RNG.prototype.nextFloat = function() {
  return this.nextInt() / (this.m - 1);
}
RNG.prototype.nextRange = function(start, end) {
  var rangeSize = end - start;
  var randomUnder1 = this.nextInt() / this.m;
  return start + Math.floor(randomUnder1 * rangeSize);
}
RNG.prototype.choice = function(array) {
  return array[this.nextRange(0, array.length)];
}
Array.prototype.shuffle = function() {
    var len = this.length;
    var i = len;
    while (i--) {
	var p = rand.nextRange(0,len);
	var t = this[i];
	this[i] = this[p];
	this[p] = t;
    }
};
Array.prototype.extract = function(x) {
    var len = this.length;
    var res = [];
    for (var i = 0; i < x.length; i++) {
	var t = x[i];
	var p = this.indexOf(t);
	if (p < 0) continue;
	res.push(this.splice(p,1)[0]);
    }
    return res;
};

// TODO
//?X Promo cards
//?China phase 5 draw (step 1/2)
//?GFX-remove diplay() blink when ui events pendig
// Rules

// colors:
// pink: #e2c0d1, efc3d2(neu)
// violet: #cca2dd
// yellow: #d0c46a, d5bd73(neu)
// brown: #b29d7b, c2a688(neu), d2985f(bnx)
// red: #be7b75, d37a75(neu), c05c4d(bnx)
// orange: #f1d278, fcb400(neu)
// green: #9ec37c(neu), 7fa791 (bnx)
// blue: 7e8395(bnx)
// gbr: pink, violet, yellow, brown, red, orange
// neu: pink, yellow, brown, red, orange, green
// bnx,ceu: violet, blue, red, yellow, brown, blue-green
// jpn: red, yellow, violet, green, brown
// rus: red, yellow, violet, pink, green, brown

// 0 - yellow: (yellow) #FFFF00
// 1 - red: (red) #FF0000
// 2 - brown: (sienna) #A0522D
// 3 - violet: (darkviolet) #9400D3
// 4 - blue: (mediumblue) #0000CD
// 5 - bluegeen: (seagreen) #2E8B57
// 6 - green: (limegreen) #32CD32
// 7 - pink: (pink) 	#FFC0CB
// 8 - orange  (orange)	#FFA500

/*if (window.applicationCache) {
    applicationCache.addEventListener('updateready', function() {
        if (confirm('An update is available. Reload now?')) {
            window.location.reload();
        }
    });
}*/
// var xhr= new XMLHttpRequest();
// xhr.open('GET', 'x.html', true);
// xhr.onreadystatechange= function() {
//     if (this.readyState!==4) return;
//     if (this.status!==200) return; // or whatever error handling you want
//     document.getElementById('y').innerHTML= this.responseText;
// };
// xhr.send();

// Translations:
var languages = ['en','de','pl'];
var dict = {
'#Title':{
    en:'P<small>OWER</small> <small>GRI</small>D: Power Plant Market',
    de:'F<small>UNKENSLA</small>G: Kraftwerksmarkt',
    pl:'W<small>YSOKIE</small> <small>NAPIĘCI</small>E: Rynek Elektrowni'
},

'Step':{de:'Stufe',pl:'Etap'},

'Player order':{de:'Reihenfolge',pl:'Kolejność graczy'},
'Auction':{de:'Kraftwerke',pl:'Licytacja'},
'Resources':{de:'Rohstoffe kaufen',pl:'Zakup surowców'},
'Building':{de:'Bauen',pl:'Rozbudowa sieci'},
'Bureaucracy':{de:'Bürokratie',pl:'Biurokracja'},

'Players':{de:'Spieler',pl:'Graczy'},
'Build':{pl:'Buduj'},
'Next':{pl:'Dalej'},
'Undo':{pl:'Wróć'},
'Pass':{pl:'Pas'},
'Out of space':{pl:'Brak miejsca'},
'Report a problem':{pl:'Zgłoś problem'},
'Game over':{pl:'Koniec gry'},
'End game':{pl:'Wyście'},
'Exit game?':{pl:'Zakończyć grę?'},

'Random regions':{pl:'Losowe regiony'},
'New Game':{pl:'Nowa gra'},
'Regions':{de:'Regionen',pl:'Regiony'},
'choose':{pl:'wybierz'},
'more':{pl:'więcej'},
'less':{pl:'mniej'},
'Promo cards':{de:'Promokarten',pl:'Karty promocyjne'},
'Number of regions chosen on map':{de:'Anzahl an Regionen auf der Landkarte',pl:'Liczba regionów na mapie, które biorą udział w grze'},
'Number of cities chosen on map':{de:'Anzahl an Städten auf der Landkarte',pl:'Liczba miast na mapie, które biorą udział w grze'},
'Maximum number of power plants owned':{de:'Maximale Anzahl an Kraftwerken im Besitz der Spieler',pl:'Maksymalna liczba elektrowni w posiadaniu gracza'},
'Number of connected cities to trigger step 2 / game end':{de:'Anzahl an angeschlossenen Städten für Wechsel zu Stufe 2 / zum Auslösen des Spielendes',pl:'Minimalna liczba miast w sieci powodująca przejście do etapu 2 / koniec gry'},
'Starting money':{pl:'Elektro na starcie'},
'Initial resource costs':{pl:'Początkowe koszty zasobów'},


'Standard Deck':{pl:'Talia podstawowa'},
'New Deck':{pl:'Nowa talia'},
'Mixed Deck':{pl:'Talia mieszana'},
'Big Game Deck':{pl:'Duża talia'},

//Region names:


//Map names:
'Germany':{de:'Deutschland',pl:'Niemcy'},
'USA':{},
'France':{de:'Frankreich',pl:'Francja'},
'Italy':{de:'Italien',pl:'Włochy'},
'Benelux':{},
'Central Europe':{de:'Mitteleuropa',pl:'Europa Środkowa'},
'Korea':{},
'China':{pl:'Chiny'},
'Brazil':{de:'Brasilien',pl:'Brazylia'},
'Spain & Portugal':{de:'Spanien & Portugal',pl:'Hiszpania i Portugalia'},
'Russia':{de:'Russland',pl:'Rosja'},
'Japan':{pl:'Japonia'},
'Québec':{},
'Baden-Württemberg':{pl:'Badenia-Wirtembergia'},
'Northern Europe':{de:'Nordeuropa',pl:'Północna Europa'},
'United Kingdom & Ireland':{de:'United Kingdom & Irland',pl:'Wielka Brytania i Irlandia'},

//Promo names:
'Flux-Generator':{},
'Transformer Station':{de:'Umspannwerk',pl:'Trafostacja'},
'Warehouse':{de:'Lagerhalle',pl:'Magazyn'},
'Shortage of Resources':{de:'Rohstoffmangel',pl:'Niedobór zasobów'},
'Surplus of Resources':{de:'Rohstoffüberschuss',pl:'Nadwyżka zasobów'},
'Theme Park':{de:'Freizeitpark',pl:'Lunapark'},
'Supply Contract':{de:'Liefervertrag',pl:'Umowa dostawy'},
'Industrial Espionage':{de:'Industriespionage',pl:'Wywiad gospodarczy'},

//'':{de:''},
}


// Game constants

var regionsno = [ null, null, 3, 3, 4, 5, 5];
var maxplantsno = [ null, null, 4, 3, 3, 3, 3];
var bigcitiesno = [ null, null, 24, 24, 32, 40, 42];
var toremove = [ null, null, 8, 8, 4, 0, 0];
var limits = [ null, null, [10,21], [7,17], [7,17], [7,15], [6,14]];
var limitsbig = [ null, null, [12,24], [8,20], [8,20], [8,18], [7,15]];
var limitsbad = [ null, null, [9,21], [6,17], [6,17], [6,15], [5,14]];
var decks = [
{ id: 'S', name: 'Standard Deck' },
{ id: 'N', name: 'New Deck' },
{ id: 'M', name: 'Mixed Deck'},
{ id: 'B', name: 'Big Game Deck' },
];
var regionchoice = {
6:{3:'GKScMUeYiqNVfZjr\\ltx',4:'OWg[ks]muy^nvz|',5:'_ow{}~'},
5:{3:'GKSMUYNVZ\\',4:'OW[]^',5:'_'}
};
var gerregions = { colors:'521043', bad:'SceqVfrgsv',
    names: [ 'North West', 'North East', 'Central West', 'Central East', 'South West', 'South' ] };
var usaregions = { colors:'350126', bad:'ScYqVfZr[sv',
    names: [ 'North West', 'South West', 'North Central', 'South Central', 'North East', 'South East' ] };
var fraregions = { colors:'405132', bad:'VZjlt',
    names: [ 'Central', 'East', 'South East', 'South West', 'North West', 'North East' ] };
var itaregions = { colors:'231045', bad:'KScMUeYiqVZjrW[ks]muyz{}',
    names: [ 'South / Sicily', 'South Central', 'Central', 'North Central', 'North West', 'North East' ] };
var ceuregions = { colors:'035214', bad:'ScYqVfZr[sv',
    names: [ 'Austria', 'Hungary', 'Czech Republic', 'Slovakia', 'Western Poland', 'Eastern Poland' ] };
var bnxregions = { colors:'2501A', bad:'KSYZ[',
    names: [ 'Holland / Utrecht', 'Netherlands East', 'Netherlands South', 'Flanders / Brussels', 'Wallonia / Luxemburg' ] };
var korregions = { colors:'603271', bad:'ScYqVfZr[sv',
    names: [ 'South West', 'South East', 'Central West', 'Central East', 'North West', 'North East' ] };
var chnregions = { colors:'621073', bad:'ScYqVfZrx[syvz{',
    names: [ 'East', 'South East', 'North', 'South West', 'North East', 'North West' ] };
var braregions = { colors:'260317', bad:'SceqVfrgsv',
    names: [ 'South', 'South East', 'North West', 'Central', 'North', 'North East' ] };
var iberegions = { colors:'016327', bad:'SceqVfrgsv',
    names: [ 'Portugal', 'South', 'North West', 'Central', 'North', 'East' ] };
var jpnregions = { colors:'10362', bad:'KSMUYVZW[]',
    names: [ 'Kyushu', 'Chugoku / Shikoku', 'Kansai / Chubu', 'Kanto', 'Tohoku / Hokkaido' ] };
//    names: [ 'Kyushu (Fukuoka)', 'Chugoku / Shikoku (Kobe)', 'Kansai / Chubu (Osaka)', 'Kanto (Tokyo / Yokohama)', 'Tohoku / Hokkaido (Sapporo)' ] };
var rusregions = { colors:'273601', bad:'SceiqVfjrlgksmnvo',
    names: [ 'Southern', 'Central', 'Volga', 'Northwestern', 'Ural', 'Siberian' ] };
var queregions = { colors:'137026', bad:'GScYqVfZrxWg[syvzw{',
    names: [ 'South', 'West', 'Quebec', 'Central', 'East', 'North' ] };
var badregions = { colors:'53041', bad:'SV',
    names: [ 'South West', 'South East', 'Central West', 'Central East', 'North' ] };
var gbrregions = { select:true, colors:'682017', bad:'MUNV\\OW]^_',
    names: [ 'Ireland', 'Northern Ireland', 'Scotland', 'Wales', 'Southern England', 'Northern England' ],
    cities:[ 7, 5, 7, 6, 8, 7 ] };
var neuregions = { select:true, colors:'813027', bad:'cUYiqVfjky',
    names: [ 'Denmark', 'Norway', 'Southern Sweden', 'Northern Sweden', 'Finland', 'Baltic States' ] };

var std0 = [3,4,3,4,5,3,5,6,4,5,7,5,7,9,6];
var std1 = [2,2,4,2,3,4,3,4,5,4,5,6,5,6,7];
var std2 = [1,2,3,1,2,3,2,3,4,3,3,5,3,5,6];
var std3 = [1,1,1,1,1,1,1,2,2,2,3,2,2,3,3];
var stdrefill = [std0,std1,std2,std3];
var iberefill = [[3,4,2,4,5,2,4,6,3,4,7,3,6,8,4],[2,3,5,2,4,5,3,5,6,4,6,7,5,7,9],std2,[0,2,1,0,2,1,0,4,1,0,5,1,0,5,2]];
var ceurefill = [[4,5,3,5,6,3,6,7,5,7,8,5,8,10,6],[1,2,3,2,2,3,2,3,4,3,4,5,4,5,6],[1,3,3,1,3,3,2,4,4,3,4,5,3,6,6],[1,1,1,1,1,1,1,2,1,2,2,2,2,3,2]];
var querefill = [[3,3,3,4,4,3,5,4,4,5,5,5,7,6,6],[2,2,3,2,3,3,3,4,4,4,5,4,5,6,5],std2,std3];
var bnxrefill = [std1,std0,std2,std3];
var rusrefill = [std1,[3,4,3,3,4,3,5,6,4,5,7,5,7,9,6],[2,2,3,2,2,3,3,3,4,4,3,5,4,5,6],std3];
var gbrrefill = [[3,4,3,3,5,3,4,6,4,4,7,5,6,8,6],[2,3,2,2,4,2,3,5,3,4,6,6,5,7,5],[1,2,2,1,2,2,2,3,3,3,3,5,3,5,5],[1,1,1,1,2,1,1,3,1,2,4,2,2,4,3]];
var chnrefill = [[4,4,3,5,5,3,6,6,4,7,7,5,9,9,6],[2,2,4,3,3,4,4,4,5,5,5,6,6,6,7],[2,2,1,2,2,1,3,3,2,3,3,3,5,5,3],[1,1,1,1,1,1,2,2,2,3,3,2,3,3,3]];
var brarefill = [std2,std0,std1,std3];
var neurefill = [[2,4,3,2,4,4,4,5,5,4,5,6,6,8,5],[1,2,3,2,2,3,2,3,4,3,4,5,4,5,6],std2,[1,2,2,1,2,2,2,3,2,2,4,3,2,4,4]];
var korrefill = [[12,22,12,22,23,12,23,33,22,23,34,23,34,45,33],[11,11,13,11,12,13,12,13,23,13,23,24,23,24,34],[1,11,12,1,11,12,11,12,22,12,12,23,12,23,33],std3];

var maps = [
{ id: 'GER', name: 'Germany', regions: gerregions, startcost: [1,3,7,14], refill: stdrefill},
{ id: 'USA', name: 'USA', regions: usaregions, startcost: [1,3,7,14], refill: stdrefill },
{ id: 'ITA', name: 'Italy', regions: itaregions, startcost: [3,4,5,14], refill: stdrefill },
{ id: 'FRA', name: 'France', regions: fraregions, startcost: [1,3,7,5], refill: stdrefill },
{ id: 'CEU', name: 'Central Europe', regions: ceuregions, startcost: [1,3,7,8], refill: ceurefill },
{ id: 'BNX', name: 'Benelux', regions: bnxregions, startcost: [3,1,7,14], refill: bnxrefill },
{ id: 'KOR', name: 'Korea', regions: korregions, startcost: [1,3,7,14], refill: korrefill },
{ id: 'CHN', name: 'China', nodecks: 'MB', regions: chnregions, startcost: [5,5,7,'-'], refill: chnrefill },
{ id: 'BRA', name: 'Brazil', regions: braregions, startcost: [1,3,7,14], refill: brarefill },
{ id: 'IBE', name: 'Spain & Portugal', regions: iberegions, startcost: [1,3,6,5], refill: iberefill },
{ id: 'JPN', name: 'Japan', nodecks: 'B', regions: jpnregions, startcost: [2,4,6,12], refill: stdrefill },
{ id: 'RUS', name: 'Russia', nodecks: 'M', regions: rusregions, startcost: [3,1,'-',6], refill: rusrefill },
{ id: 'QUE', name: 'Québec', regions: queregions, startcost: [2,2,7,14], refill: querefill },
{ id: 'BAD', name: 'Baden-Württemberg', nodecks: 'B', regions: badregions, startcost: [1,3,7,14], refill: stdrefill },
{ id: 'GBR', name: 'United Kingdom & Ireland', regions: gbrregions, startcost: [1,3,5,'-'], refill:gbrrefill },
{ id: 'NEU', name: 'Northern Europe', nodecks: 'MB', regions: neuregions, startcost: [3,3,5,7], refill:neurefill },
];
var plants =    [ '03A','04A','05A','06A','07A','08A','09A','10A','11A','12A','13A','14A','15A',
                  '16A','17A','18A','19A','20A','21A','22A','23A','24A','25A','26A','27A','28A',
                  '29A','30A','31A','32A','33A','34A','35A','36A','37A','38A','39A','40A',
                  '42A','44A','46A','50A' ];
var newplants = [ '01B','02B','03B','04B','05B','06B','07B','08B','09B','10B','11B','12B','13B',
                  '14B','15B','16B','19B','20B','21B','22B','23B','24B','25B','26B','27B','28B',
                  '29B','30B','31B','32B','33B','34B','35B','36B','37B','38B','39B','40B',
                  '42B','44B','46B','50B' ];
var bigplants = [ '52B','54B','57B','60B' ];
var step3 = '999';

var topdeckplants = [ '13A', '11B' ];
var ecoplants = [ '13A','18A','22A','27A','33A','37A','44A',
                  '10B','11B','15B','16B','26B','32B','39B' ];
var gasplants = [ '06A','14A','19A','24A','30A','38A',
                  '06B','21B','27B','33B','42B','52B' ];
var neplants = [
    [ [ '19A', '26A', '22B', '27B' ], [ '19C', '26C' ]],
    [ [ '07A', '46A', '07B', '36B' ], [ '07C', '46C' ]],
    [ [ '10A', '39A', '09B', '38B' ], [ '10C', '39C' ]],
    [ [ '21A', '25A', '28B', '29B' ], [ '21C', '25C' ]],
    [ [ '32A', '44A', '25B', '39B' ], [ '32C', '44C' ]],
    [ [ '18A', '22A', '15B', '16B' ], [ '18C', '22C' ]],
];

var promos = [
{ name: 'Flux-Generator', val: 6, card: '33D' },
{ name: 'Transformer Station', val: 7, card: 'X01' },
{ name: 'Warehouse', val: 8, card: 'X02' },
{ name: 'Shortage of Resources', val: 9, card: 'X03' },
{ name: 'Surplus of Resources', val: 10, card: 'X04' },
{ name: 'Theme Park', val: 11, card: 'X05' },
{ name: 'Supply Contract', val: 12, card: 'X06' },
{ name: 'Industrial Espionage', val: 13 },
];

var version = 1;
// Game state

var players = 3;
var ingame = 0;
var gamelog = '';
var deck = 0; // 0-classic, 1-new, 2-mix (variant 2), 3-big (variant 3)
var map = 0;
var options = 0; // bitmask: 0-5, regions for GBR, NEU; 6+ promos

// UI state

var debugmode = 0;
var alttable = 0;
var lang = 'en';
var ui_calc = 0;
var ui_calc_state = [];

function fix_lang() {
    if (languages.indexOf(lang) < 0) lang = languages[0];
}

if (navigator.userLanguage) // IE
    lang = navigator.userLanguage;
else if (navigator.language) // Others
    lang = navigator.language;
lang = lang.match(/[a-z]*/i);
fix_lang();

function set_lang(x) {
    lang = x;
    save_state();
}

function t(x) {
    return dict[x] && dict[x][lang] ? dict[x][lang] : x;
}

function set_state(s) {
    if (!s) return;
    var state = s.split(',');
    if (state[0] != version) {
	alert('Ignoring old game state');
	return;
    }
    ingame = parseInt(state[1]);
    players = parseInt(state[2]);
    deck = parseInt(state[3]);
    map = parseInt(state[4]);
    options = parseInt(state[5]);
    gamelog = state[6];
    lang = state[7];
    fix_lang();
    if (gamelog) init_game(gamelog);
    alttable = parseInt(state[8]);
    if (!alttable) alttable = 0;
    debugmode = parseInt(state[9]);
    if (!debugmode) debugmode = 0;
    ui_calc = parseInt(state[10]);
    if (!ui_calc) ui_calc = 0;
}
function get_state() {
    return [version,ingame,players,deck,map,options,gamelog,lang,alttable,debugmode,ui_calc].join(',');
}    

//var storage = sessionStorage;
var storage = localStorage;
function load_state() {
    set_state(storage.getItem('state'));
}
function save_state() {
    storage.setItem('state',get_state());
}

function deck_id() { return decks[deck].id; }
function map_id() { return maps[map].id; }
function plant_val(a) { return parseInt(a,10); }
function get_limits() {
    if ('B' == deck_id()) return limitsbig[players];
    if ('BAD' == map_id()) return limitsbad[players];
    if ('GBR' == map_id() && players == 2) {
	var c = 0;
	if (chosen_regions() == regionsno[players]) {
	    for (var i = 0; i < 6; i++) if (has_option(i)) c += maps[map].regions.cities[i];
	} else {
	    c = 'x';
	}
	return [limits[2][0],c];
    }
    return limits[players];
}
function has_option(v) {
    return options & (1 << v);
}
function chosen_regions() {
    var ret = 0;
    for (var i = 0; i < 6; i++) if (has_option(i)) ret++;
    return ret;
}
function has_espionage() { return has_option(13); }

function random_regions() {
    var possible = regionchoice[maps[map].regions.names.length][regionsno[players]].split('');
    possible.extract(maps[map].regions.bad.split(''));
    var r = Math.floor(Math.random() * possible.length);
    var r = 0x3f & possible[r].charCodeAt(0);
    for (var i = 0; i < 6; i++)
	set_option(i, r & (1<<i) ? 1 : 0);
}

function mixplants() {
    var tmp = plants.concat(newplants);
    var ret = [];
    var have = {};
    tmp.shuffle();
    for(var i = 0; i < tmp.length; i++) {
	var val = plant_val(tmp[i]);
	if (!have[val] && val != 17 && val != 18) {
	    ret.push(tmp[i]);
	}
	have[val] = 1;
    }
    ret.sort();
    return ret;
}

function init_deck() {
    var p = plants;
    var remove = toremove[players];
    marketsize = 4; // for Russia
    if ('N' == deck_id()) p = newplants;
    if ('M' == deck_id()) p = mixplants();
    if ('B' == deck_id()) {
	p = p.concat(bigplants, newplants.slice(-2));
	remove = remove / 4 * 5;
    }

    stack = p.slice(0);
    if ('RUS' == map_id()) {
	stack.extract(['06A','14A','06B','21B'])
	marketsize = 3;
    } else if ('CHN' == map_id()) {
	stack.extract(['03A','04A','33A','01B','02B','32B']);
	if (players < 5)
	    stack.extract(['11A','18A','24A','46A','08B','15B','27B','36B']);
	if (players < 4)
	    stack.extract(['09A','16A','20A','30A','12B','22B','28B','42B']);
	market = stack.splice(0,players);
	var pos = stack.indexOf('S' == deck_id()?'31A':'30B');
	var tmp1 = stack.splice(pos);
	pos = tmp1.indexOf('S' == deck_id()?'36A':'35B');
	var tmp2 = tmp1.splice(pos);
	tmp1.push(step3);
	if (has_option(promos[0].val)) tmp1.push(promos[0].card); // Flux generator
	tmp1.shuffle();
	tmp2.shuffle();
	stack = stack.concat(tmp1,tmp2);
	for (var i = 1; i < promos.length; i++) if (has_option(promos[i].val) && promos[i].card) {
	    stack.splice(rand.nextRange(0,stack.length+1),0,promos[i].card);
	}
	return;
    } else if ('NEU' == map_id()) {
	for (var i = 0; i < 6; i++) if (has_option(i)) {
	    stack.extract(neplants[i][0]);
	    stack = stack.concat(neplants[i][1]);
	}
	stack.sort();
    }
    market = stack.splice(0,marketsize * 2);

    var topdeck = [];
    var bottomdeck = [];
    if ('M' != deck_id()) {
	topdeck = stack.extract(topdeckplants);
	if ('FRA' == map_id()) {
	    topdeck = stack.extract(['11A','19B']);
	} else if ('BRA' == map_id()) {
	    topdeck = topdeck.concat(stack.extract(['14A','21B']));
	} else if ('IBE' == map_id()) {
	    step2plants = stack.extract(['18A','22A','27A','15B','16B','26B']);
	} else if ('RUS' == map_id()) {
	    var tmp = stack.extract(['10A','11A','08B','09B']);
	    stack.shuffle();    
	    tmp = tmp.concat(stack.splice(-3));
	    tmp.shuffle();
	    topdeck = topdeck.concat(tmp);
	} else if ('QUE' == map_id()) {
	    topdeck = topdeck.concat(stack.extract(['18A','22A','15B','16B']));
	}
    }
    if ('GBR' == map_id()) {
	stack.shuffle();
	bottomdeck = stack.splice(-2);
    }
    if (remove) {
	var save;
	if ('BRA' == map_id()) save = stack.extract(gasplants);
	if ('QUE' == map_id()) save = stack.extract(ecoplants);
	stack.shuffle();
	stack.splice(-remove);
	if (save) {
	    stack = stack.concat(save);
	}
    }
    for (var i = 0; i < promos.length; i++) if (has_option(promos[i].val) && promos[i].card) {
	stack.push(promos[i].card);
    }
    stack.shuffle();
    stack = topdeck.concat(stack,[step3],bottomdeck);
}

function init_game(state) {
    var oldlog = '';
    market = [];
    phase = 2; // 2->4->5
    step = 1;
    turn = 1;
    stack = [];
    houses = 0;
    playersleft = players;
    sold = 0;
    step2plants = undefined; // for Spain & Portugal
    log_clear();
    if (state) {
	state = state.split('|');
	rand = new RNG(parseInt(state[0]));
	oldlog = state[1];
    } else {
	rand = new RNG();
    }
    log_append(rand.state + '|');
    init_deck();
    if ('B' == deck_id()) {
	cities = bigcitiesno[players];
    } else if (maps[map].regions.cities) {
	cities = 0;
	for (var i = 0; i < 6; i++) if (has_option(i)) {
	    cities += maps[map].regions.cities[i];
	}
    } else {
	cities = regionsno[players] * 7;
    }
    ui_init_game();
    replay(oldlog);
    flush_events();
}

// State variables modifiers
function log_clear() {
    gamelog = '';
    save_state();
}
function log_append(a) {
    gamelog += a;
    save_state();
}
function set_players(n) {
    players = n;
    for (var i = 0; i < 6; i++)
	set_option(i, 0);
    save_state();
}
function set_deck(v) {
    deck = v;
    if ('B' == deck_id())
    for (var i = 0; i < 6; i++)
	set_option(i, 0);
    save_state();
}
function set_map(v) {
    if (map == v) return;
    for (var i = 0; i < 6; i++)
	set_option(i, 0);
    if(maps[v].nodecks && maps[v].nodecks.search('P') >= 0) {
	for (var i = 0; i < promos.length; i++)
	    set_option(promos[i].val, 0);
    }
    if(maps[v].nodecks && maps[v].nodecks.search(deck_id()) >= 0)
	set_deck(0);
    map = v;
    save_state();
}
function set_option(o,v) {
    if (v) {
	options |= 1 << o;
    } else {
	options &= ~(1 << o);
    }
    save_state();
}
function set_ingame(v) {
    ingame = v;
    save_state();
}
function replay(inlog) {
    for (var i = 0; i < inlog.length; i++) {
	var c = inlog.substr(i, 1);
	switch (c) {
	    case 'B': do_build(); break;
	    case 'E': do_endbuild(); break;
	    case 'T': do_endturn(); break;
	    case 'P': do_pass(); break;
	    case 'A': do_passall(); break;
	    case 'N': do_nospace(); break;
	    default: do_buy(parseInt(c)); break;
	}
    }
}


// Market/stack manipulation:
function market_remove(i) {
    { // DISPLAYEVENT
    var ev = {};
    ev[market[i]] = [ 1.5, 2.5, 3, 1];
    mvqueue.push(ev);
    }
    market.splice(i,1);
}
function market_shift() {
    market_remove(0);
}
function market_pop() {
    market_remove(market.length - 1);
    // DISPLAYEVENT
    {
    var ev = {};
    for (var i = 0; i < market.length; i++) {
	var m = ui_market_width();
	ev[market[i]] = [  i % m, i >= m, 3, 1];
    }
    mvqueue.push(ev);
    }
}
function market_to_stack(i) {
    if (i < 0) i = market.length - 1;
    { // DISPLAYEVENT
    var ev = {};
	ev[market[i]] = [4,1, 1, 1];
    mvqueue.push(ev);	
    }
    stack.push(market.splice(i,1)[0]);
}
function stack_reveal(p) {
    if (!stack.length) return;
    { // DISPLAYEVENT
    var ev = {};
	ev[stack[0]] = [4,1, 3, p?3:1,p];
    mvqueue.push(ev);	
    }
}

function draw() {
    if (!stack.length) return;
    if (stack[0].substr(0,1) == 'X') {
	stack_reveal(1);
	{ // DISPLAYEVENT
	var ev = {};
	    ev[stack[0]] = [1.5,2.5, 3, 1];
	mvqueue.push(ev);	
	}
	stack.shift();
	draw();
	return;
    }
    var plant = stack.shift();
    if (plant == step3 && 'CHN' != map_id()) {
	stack.shuffle();
    }
    market.push(plant);
    market.sort();
    // DISPLAYEVENT
    {
    var ev1 = {}, ev2 = {};
    for (var i = 0; i < market.length; i++) {
	var m = ui_market_width();
	var newpos = [ i % m, i >= m, market[i] != plant ? 3 : 4, 1];
	ev1[market[i]] = market[i] != plant ? newpos : [4, 1, 3, 3];
	ev2[market[i]] = newpos;
    }
    mvqueue.push(ev1);
    mvqueue.push(ev2);
    }
    if ('BAD' != map_id() && 'RUS' != map_id() && 'CHN' != map_id())
    if(houses >= plant_val(market[0])) {
          market_shift();
          draw();
    }
}

function step2() {
    if (step2plants)
	stack = step2plants.concat(stack);
    if (market.length) {
	market_shift();
	draw();
    }
    step = 2;
    test_step3();
}

function test_step3() {
    if (market.indexOf(step3) < 0) return;
    step = 3;
    market_shift();
    market_pop();
    if ('CHN' == map_id()) while(market.length < 4) draw();
}

function do_buy(i) {
    log_append(i);
    playersleft--;
    sold = 1;
    market_remove(i);
    if ('CHN' != map_id() || step == 3)
	draw();
    if (!playersleft) {
        test_step3();
        phase = 4;
    }
}

function aucion_pass() {
    playersleft--;
    if ('RUS' == map_id()) {
	market_shift();
	draw();
    }
    if (!playersleft) {
        if (!sold && 'RUS' != map_id() && 'CHN' != map_id()) {
            market_shift();
            draw();
	    if ('BAD' == map_id()) {
		market_shift();
		draw();
	    }
        }
        test_step3();
        phase = 4;
    }
}

function do_pass() {
    log_append('P');
    aucion_pass();
}

function do_passall() {
    log_append('A');
    while(playersleft) 
	aucion_pass();
}

function do_build() {
    log_append('B');
    houses++;
    if ('BAD' != map_id() && 'RUS' != map_id() && 'CHN' != map_id())
    while(houses >= plant_val(market[0])) {
        market_shift();
        draw();
    }
}
function do_endbuild() {
    var lim = get_limits();
    log_append('E');
    test_step3();
    if (houses >= lim[0] && step == 1) {
	step2();
    }
    if (houses >= lim[1]) {
        step = 0;
    }
    phase = 5;
}
function do_nospace() {
    log_append('N');
    step2();
    phase = 5;
}
function do_endturn() {
    log_append('T');
    if (step < 3) {
	if ('CHN' == map_id()) {
	    var d = [0,0,2,2,3,4,5][players];
	    var m = [0,0,1,1,2,2,3][players];
	    var i = d - market.length;
	    if (i < m) i = m;
	    while (i--) {
		draw();
		if (market.indexOf(step3) >= 0) break;
		if (market.length > d) market_shift();
	    }
	} else if ('QUE' == map_id()) {
	    var i;
	    for (i = market.length - 1; i >= 0; i--) {
		if (ecoplants.indexOf(market[i]) < 0) break;
	    }
	    market_to_stack(i);
	    draw();
	} else if ('BNX' == map_id()) {
	    market_to_stack(-1);
	    market_shift();
	    draw();
	    draw();
	} else {
	    market_to_stack(-1);
	    draw();
	}
        test_step3();
    } else if (market.length > 0) {
        market_shift();
        draw();
    }
    turn++;
    phase = 2;
    sold = 0;
    playersleft = players;
}

function market_availiable() {
    var ret = market.length;
    if (step < 3 && 'CHN' != map_id() && ret > marketsize) {
	ret = marketsize;
	if ('BNX' == map_id() && ecoplants.indexOf(market[ret]) >= 0)
	    ret++;
    }
    return ret;
}
function nospace_active() {
    return step == 1 && phase == 4 && players * houses >= cities && houses < get_limits()[0];
}

function undo_active() {
    return gamelog.substr(-1) != '|';
}
function nextphase_active() {
    if (phase == 2 && turn == 1) return 0;
    return step > 0;
}

function region_select() {
    return maps[map].regions.select && 'B' != deck_id();
}
function pass_active() {
    return phase == 2 && turn > 1 && 'RUS' == map_id();
}
// User intrerface functions

function buy(i) {
    if (market_availiable() > i && phase == 2) {
	flush_events();
        do_buy(i);
    }
    display();
}
function pass() {
    if (phase == 2 && turn > 1) {
	flush_events();
        do_pass();
    }
    display();
}
function passall() {
    if (phase == 2 && turn > 1) {
	flush_events();
        do_passall();
    }
    display();
}
function build() {
    if (phase == 4) {
	flush_events();
        do_build();
    }
    display();
}
function nospace() {
    if (phase == 4 && step == 1) {
	flush_events();
        do_nospace();
    }
    display();
}
function endbuild() {
    if (phase == 4) {
	flush_events();
        do_endbuild();
    }
    display();
}
function endturn() {
    if (phase == 5 && step > 0) {
	flush_events();
        do_endturn();
    }
    display();
}
function nextphase() {
    if (phase == 2) {
	passall();
    } else if (phase == 4) {
	endbuild();
    } else if (phase == 5) {
	endturn();
    }
}
function start_game() {
    set_ingame(1);
    init_game();
    display();
}

function end_game() {
    if (!step || confirm(t('Exit game?')))
	set_ingame(0);
    display();
}

function undo() {
    init_game(gamelog.substr(0,gamelog.length-1));
    display();
}

function report_mail() {
    var ret = 'mailto:pgmarketaid@gmail.com';
    ret += '?subject=Online report';
    ret += '&body=Keep this line:%0d';
    ret += get_state();
    if (navigator) ret += ' / ' + navigator.userAgent;
    return ret;
}

// User interface

document.onkeydown = function(e) {
    if (e.ctrlKey && e.keyCode == 69) {
        debugmode = debugmode ? 0 : 1;
	save_state();
	display();
	return false;
    }
    if (!ingame) return;
    if (e.keyCode > 48 && e.keyCode < 55) {
        buy(e.which - 49);
    } else if (e.ctrlKey && e.keyCode == 90 && undo_active()) {
        undo();
    } else if (e.keyCode == 78) {
	nextphase();
    } else if (e.keyCode == 66) {
	build();
    } else if (e.keyCode == 67) {
	ui_calc_switch();
    } else if (e.keyCode == 27) {
	if (ui_calc) ui_calc_switch(); else end_game();
    } else if (e.keyCode == 80 && pass_active()) {
        pass();
    } else if (e.keyCode == 79 && nospace_active()) {
        nospace();
    } else {
	return true;
    }
    return false;
}

function ui_set_regions(elem) {
    for (var i = 0; i < 6; i++) {
	set_option(i, elem.options[i].selected);
    }
    display();
}

function ui_set_pos(name,x,y,z) {
    var px = Math.round(10 + 198 * x);
    var py = Math.round(10 + 198 * y);
    var item = document.getElementById("card"+name);
    if (!item) return;
    item.style.left = px + 'px';
    item.style.top = py + 'px';
    item.style.zIndex = z;
}

var lastpos = {};

function ui_card(name,forsale) {
    var px = 10 + 198 * lastpos[name][0];
    var py = 10 + 198 * lastpos[name][1];
    var ret ='';
    ret += '<div class="card'+(forsale >=0 ? 1:0)+'" style="';
    ret += 'background: url(img/'+name+'.jpg);';
    ret += 'background-size: cover;'
    ret += 'top:'+py+'px;left:'+px+'px;z-index:1"';
    ret += ' id="card' + name + '"';
    if (forsale >= 0) ret += ' onClick="buy('+forsale+')"';
    ret += '>';
//    ret += name;
    ret += '</div>';
    return ret;
}
function ui_stack() {
    var px = 10 + 198 * 4;
    var py = 10 + 198 * 1;
    var ret ='';
    ret += '<div class="card0" style="'
    ret += 'background: url(img/DEC.jpg);';
    ret += 'background-size: cover;'
    ret += 'z-index:2;';
    ret += 'top:'+py+'px;left:'+px+'px;"';
    if (has_espionage())
	ret += ' onclick="stack_reveal(0)"';
    ret += '>';
    ret += '</div>';
    return ret;
}

function ui_alttable() {
    alttable = 1 - alttable;
    save_state();
    display();
}

function ui_step() {
    var pos = ui_market_width() > 4 ? [3,1] : [4,0];
    var px = 10 + 198 * pos[0];
    var py = 10 + 198 * pos[1]+10;
    var alt = alttable;
    var ret ='';
    ret += '<div style="position:absolute;width:188px;height:188px;'
    ret += 'border:0px solid black;text-align:center;';
    ret += 'top:'+py+'px;left:'+px+'px;" onClick="ui_alttable()">';
    if (!alt) ret += '<div style="font-size:44px">'+(step?t('Step')+' '+step:t('Game over'))+'</div>';
    ret += '<table align="center">';
    if (!alt) {
    ret += '<tr>';
    for (var i = 1; i <= 4; i++) {
	ret += '<td width="28" height="50">';
	ret += '<img src="img/R'+i+'.png" height="35">';
	ret += '</td>';
    }
    ret += '</tr>';
    }
    for (var s = 1; s <= 3; s++) if (s == step || alt) {
	var rows = 'KOR' == map_id() ? 2:1;
	var h = rows == 2 ? 24 : 50;
	var fh = rows == 2 ? 24 : 30;
	for (var j = 0; j < rows; j++) {
	    ret += '</tr>';
	    for (var i = 1; i <= 4; i++) {
		var bgcol = s == step ? (i%2?'3e6e3e':'a7bc95') : (i%2?'4e4e4e':'a8a8a8');
		var fgcol = (i%2?'white':'black');
		var cost = maps[map].refill[i-1][s-1+(players-2)*3];
		if (rows > 1) cost = j ? cost % 10 : Math.floor(cost / 10);
		ret += '<td width="28" height="'+h+'" style="font-size:'+fh+'px;background-color:#'+bgcol+';color:'+fgcol+';">';
		ret += '<div style="max-height:'+h+'px;line-height:'+h+'px;">'
		ret += cost;
		ret += '</div></td>';
	    }
	    ret += '</tr>';
	}
    }
    ret += '</table>';
    ret += '</div>';
    return ret;
}
function ui_button(x,y,w,h,name,func) {
	var ret = '';
	x++; y++; w-=2; h-=2;
	var hf = Math.ceil(h*.7);
	ret += '<div class="button'+(func?1:0)+'" style="font-size:'+hf+'px;line-height:'+h+'px;left:'+x+'px;top:'+y+'px;width:'+w+'px;height:'+h+'px;"';
	ret += ' onClick="'+func+'()"';
	ret += '>';
	ret += t(name);
	ret += '</div>';
	return ret;
}

function ui_phase(x,y,w,h,name,on) {
	var ret = '';
	x++; y++; w-=2; h-=2;
	ret += '<div class="phase'+(on?1:0)+'" style="line-height:'+h+'px;left:'+x+'px;top:'+y+'px;width:'+w+'px;height:'+h+'px;">';
	ret += name;
	ret += '</div>';
	return ret;
}

function ui_calc_switch() {
    ui_calc = 1 - ui_calc;
    save_state();
    display();
}

function ui_calc_house(v,s) {
    return '<span style="color:black;vertical-align:middle;position:relative;width:'+s+'px;height:'+s+'px;font-size:'+s+'px;text-align:center;">'+
    '<img src="img/housea.png" height="'+s+'" width="'+s+'"/>'+
    '<span style="position:absolute;top:0px;left:0px;width:'+s+'px;height:'+s+'px;font-size:30px">'+v+'</span></span>';
}

function ui_calculator() {
    var tmp = '';
    if (!ui_calc) return tmp;
    var sum = 0;
    tmp += '<div class="market" style="position:absolute;top:90px;left:175px;height:335px;width:620px;z-index:20;">';
    tmp += '<div style="position:absolute;top:10px;left:10px;height:315px;width:600px;z-index:20;">';
    for (var i = 0; i < 10; i++) {
	for (var j = 0; j < 3; j++) {
	    var a = j*10+i+1;
	    tmp += ui_button(i*50,j*50,50,50,a,'ui_calc_state.push('+a+');display');
	}
    }
    tmp += ui_button(11*50,1*50,50,50,'C',ui_calc_state.length?'ui_calc_state.pop();display':'');
    tmp += ui_button(11*50,2*50,50,50,'CA',ui_calc_state.length?'ui_calc_state=[];display':'');
    tmp += ui_button(11*50,0*50,50,50,'x','ui_calc_switch');
    for (var i = 0; i < step; i++)
    tmp += ui_button(10*50,i*50,50,50,ui_calc_house(i*5 + 10,48),'ui_calc_state.push(-'+(i*5+10)+');display');
    tmp += '<div style="position:absolute;font-size:50px;line-height:55px;text-align:right;top:150px;left:0px;height:165px;width:600px;">&nbsp';
    var r = [];
    for (var i = 0; i < ui_calc_state.length; i++) {
	var v = ui_calc_state[i];
	r.push(v < 0 ? ui_calc_house(-v,50) : v);
	sum += Math.abs(v);
    }
    tmp += r.join(', ');
    tmp += '<br\>= ' + sum;
    tmp += '</div>';
    tmp += '</div></div>';
    return tmp;
}

function ui_market() {
    var ret = '<div class="panel"><div class="market" style="height:402px">';
    var m = market_availiable();
    for (var i = 0; i < m; i++) ret += ui_card(market[i], phase == 2 ? i : -1);
    for (var i = m; i < market.length; i++) ret += ui_card(market[i], -1);
    for (var i = 0; i < stack.length && i < 4; i++) ret += ui_card(stack[i], -1);
    var p = event_cards();
    if (stack.length > 0)
	ret += ui_stack();
    ret += ui_step();
    for (var i = 0; i < p.length; i++) {
	var sp = stack.indexOf(p[i]);
	if (market.indexOf(p[i]) == -1 && (sp >= 4 || sp == -1))
	    ret += ui_card(p[i], -1);
    }
//    for (var i in lastpos) {
//	var c = phase == 2 ? market.indexOf(i) : -1;
//	if (c >= m) c = -1;
//	ret += ui_card(i, c, stack.length && i == stack[0]);
//    }
    ret += '</div></div>';
    ret += '<div class="panel" style="height:2px"></div>';
    ret += '<div class="panel" style="height:105px;">';
    var lim = get_limits();
    for (i = 0; i < cities && i < 24; i++) {
	var bg = 'a';
	if (i == lim[0] - 1) bg = '2';
	if (i == lim[1] - 1) bg = '2';
	if (houses > i) bg = '3';
	ret += '<div style="font-size:18px;line-height:35px;position:absolute;left:'+i*35+'px;width:35px;height:35px;background: url(img/house'+bg+'.png);background-size: cover;">';
	ret += i + 1;
	ret += '</div>';
    }
    ret += ui_button(900,0,100,35,'Build',phase == 4?'build':'');
    for (i = 0; i < 5; i++) {
	var phasenames = ['Player order','Auction','Resources','Building','Bureaucracy'];
	var name = t(phasenames[i]);
	var bg = 0;
	var order = i;
	if (i == phase - 1) {
	    bg = 1;
	    if (phase == 2) {
		name += ': ' + (players - playersleft + 1) + '/' + players;
	    }
	}
	if (order < 2 && (turn == 1 || 'BAD' == map_id())) order ^= 1;
	ret += ui_phase(order*168,35,168,35,name,bg);
    }
    if (pass_active())
	ret += ui_button(1*168,70,168,35,'Pass','pass');
    if (nospace_active())
	ret += ui_button(3*168,70,168,35,'Out of space','nospace');
    ret += ui_button(900,35,100,35,'Next',nextphase_active()?'nextphase':'');
    ret += ui_button(900,70,100,35,'Undo',undo_active()?'undo':'');
    ret += ui_button(0,70,100,35,'End game','end_game');
    ret += ui_button(805,70,35,35,'C','ui_calc_switch');

    ret += '</div>';
    return ret;
}

function ui_market_width() {
    if ('CHN' == map_id()) return 4;
    if (step < 3) return market_availiable();
    if ('RUS' == map_id()) return 2;
    return 3;
}

function ui_init_game() {
    var m = ui_market_width();
    lastpos = {};
    mvqueue = [];
    for (var i = 0; i < m; i++) lastpos[market[i]] = [i, 0];
    for (var i = m; i < market.length; i++) lastpos[market[i]] = [i-m, 1];
    for (var i = 0; i < stack.length; i++) lastpos[stack[i]] = [4, 1];
    if (step2plants)
	for (var i = 0; i < step2plants.length; i++) lastpos[step2plants[i]] = [4, 1];
}

function display() {
    var title = t('#Title')+' v1.0i';
    var tmp = '';
    if (ingame) title = t(maps[map].name)+', '+players+' '+t('Players');
    if (debugmode) {
	tmp += '<div class="panel"><input style="width:99%" type="text" onChange="set_state(this.value);display();" value="'+get_state()+'"/><br/></div>';
    }
    tmp += '<div class="panel">';
    tmp += '<div class="header">'+title+'</div>';
    tmp += '<a style="display:none" id="report_mail" href="' + report_mail() + '"></a>';
    tmp += ui_button(900,0,100,20,'Report a problem','document.getElementById(\'report_mail\').click'); 
    for (var i = 0; i < languages.length; i++) {
	tmp += ui_button(30*i,0,30,20,languages[i].toUpperCase(),lang == languages[i]?'':'set_lang(\''+languages[i]+'\');display'); 
    }
    tmp += '</div>';
    if (ingame) {
	tmp += ui_market();
	tmp += ui_calculator();
    } else {
	tmp += '<div class="panel" style="height:50px">'
	tmp += '<select id="playersno" onChange="set_players(document.getElementById(\'playersno\').value);display();">';
	for(var i = 2; i <= 6; i++) {
	    tmp += '<option value="'+i+'"';
	    if (i == players) tmp += ' selected';
	    tmp += '>'+i+' '+t('Players')+'</option>';
	}
	tmp += '</select>';
	tmp += '<select id="mapno" onChange="set_map(this.value);display();">';
	for(var i = 0; i < maps.length; i++) {
	    tmp += '<option value="'+i+'"';
	    if (i == map) tmp += ' selected';
	    tmp += '>'+t(maps[i].name)+'</option>';
	}
	tmp += '</select>';
	tmp += '<select id="deckno" onChange="set_deck(this.value);display();">';
	for(var i = 0; i < decks.length; i++) {
	    if (maps[map].nodecks && maps[map].nodecks.search(decks[i].id) >= 0) continue;
	    tmp += '<option value="'+i+'"';
	    if (i == deck) tmp += ' selected';
	    tmp += '>'+t(decks[i].name)+'</option>';
	}
	tmp += '</select>';
	tmp += '</div><div class="panel" style="height:320px">';
	tmp += '<div class="market" style="position:absolute;top:0px;left:700px;text-align:left;height:250px;width:296px;">';
	if (region_select() || chosen_regions()) {
	    tmp += t('Regions');
	    if (region_select()) {
		var diff = regionsno[players] - chosen_regions();
		if (diff > 0) tmp += ' ('+t('choose')+' ' + diff + (chosen_regions() ? ' '+t('more') : '') + ')';
		else if (diff < 0) tmp += ' ('+t('choose')+' ' + -diff + ' '+t('less')+')';
	    }
	    tmp += ':</br>';
	    for(var i = 0; i < 6; i++) if (region_select() || has_option(i)) {
		var fg = has_option(i) ? 'black' : '#777777';
		if (region_select()) {
		    tmp += '<input type="checkbox" onChange="set_option('+i+',this.checked);display();"';
		    if (has_option(i)) tmp += ' checked';
		    tmp += '>';
		}
		tmp += '<span style="color:'+fg+';';
		if (!region_select()) tmp+= 'margin-left:20px;';
		tmp += '">'+t(maps[map].regions.names[i])+'</span>'
		tmp += ' <img style="border:1px solid '+fg+'" src="img/c'+maps[map].regions.colors.charAt(i)+'.png" width=20 height=20>';
		tmp += region_select() ? '</input><br/>' : '<br/>';
	    }
	}
	tmp += '</div>';
	tmp += '<div class="market" style="position:absolute;left:0px;text-align:left;font-size:80%;height:250px;width:296px;">';
	if (!maps[map].nodecks || maps[map].nodecks.search('P') < 0) {
	    tmp += t('Promo cards')+':</br>'
	    for(var i = 0; i < promos.length; i++) {
		tmp += '<input type="checkbox" onChange="set_option('+promos[i].val+',this.checked);display();"';
		if (has_option(promos[i].val)) tmp += ' checked';
		tmp += '><span style="color:'+(has_option(promos[i].val)?'black':'#777777')+'">'+t(promos[i].name)+'</span></input>';
	    tmp += '<br/>';
	    }
	}
	tmp += '</div>';
	tmp += '<div class="market" style="position:absolute;left:350px;height:250px;width:296px;"><table>';
//	tmp += ui_info('',[1,2,3,4].map(function (a) {return '<img height="30" src="img/R'+a+'.png"/>'}));
	tmp += ui_info('Initial resource costs',maps[map].startcost);
	if (deck_id() == 'B') {
	    tmp += ui_info('Number of cities chosen on map',[bigcitiesno[players]]);
	} else {
	    var value = regionsno[players];
	    tmp += ui_info('Number of regions chosen on map',[value]);
	}
	tmp += ui_info('Maximum number of power plants owned',[maxplantsno[players]]);
	tmp += ui_info('Number of connected cities to trigger step 2 / game end',get_limits());
	tmp += ui_info('Starting money',[50]);
	tmp += '</table></div>';
	tmp += ui_button(450,270,100,36,'New Game',region_select() && regionsno[players] != chosen_regions() ? '' : 'start_game');
	tmp += ui_button(790,273,120,30,'Random regions','B' != deck_id() ? 'random_regions();display' : '');
	tmp += '</div>';
    }
    document.getElementById("buttons").innerHTML=tmp;
}
function ui_info(name,value) {
    var l = value.length;
    var ret = '<tr><td style="text-align:right;line-height:16px;width:180px;font-size:70%">';
    ret += t(name) + '</td>';
    for(var i = 0; i < l; i++) {
	ret += '<td colspan="'+4/l+'" style="width:'+100/l+'px;line-height:42px;background-color:#a7bc95;">';
	ret += value[i] + '</td>';
    }
    ret += '</tr>';
    return ret;
}
var frames = 25;
var mvqueue = [];
function display_event() {
    setTimeout('display_event()', 1000/25);
    if (!ingame) return;
    var curmv = mvqueue[0];
    if (!curmv) return;
    for (var c in curmv) {
	var src = lastpos[c];
	var dst = curmv[c];
	var xz = frames/25;
	var px = src[0]*xz + dst[0]*(1-xz);
	var py = src[1]*xz + dst[1]*(1-xz);
	ui_set_pos(c,px,py,frames>0?dst[2]:dst[3]);
    }
    if (dst[4]) {
	    var item = document.getElementById("card"+c);
	    item.onclick = function () { cancel_event(); };
    } else
    frames--;
    if (frames < 0) {
	for (var c in curmv)
	    lastpos[c] = curmv[c].slice(0,2);
	mvqueue.shift();
	frames = 25;
    }
}
function cancel_event() {
    var e;
    if (e = mvqueue.shift())
	for (var c in e) {
	    ui_set_pos(c,e[c][0],e[c][1],e[c][3]);
	    lastpos[c] = e[c].slice(0,2);
	}
    frames = 25;
}
function flush_events() {
    while (mvqueue.length)
	cancel_event();
}
function event_cards() {
    var r = [];
    for (var i = 0; i < mvqueue.length; i++)
	for (var c in mvqueue[i])
	    if (r.indexOf(c) == -1)
		r.push(c);
    return r;
}
</script>
</head>
<body onLoad="load_state();display();display_event();">
<div id="buttons">Loading...</div>
</body>
</html> 

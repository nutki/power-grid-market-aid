<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<meta charset="UTF-8" />
<style>
@font-face {
font-family: KaufmannBold;
src: url('img/Kaufmann-Bold.ttf');
src: url('img/Kaufmann-Bold.otf');
}
@font-face {
font-family: PowerGrid;
src: url('img/PowerGrid.ttf');
}
body {
font-family:PowerGrid, Helvetica, Arial;
width:970px;
margin:0px auto;
text-align:center;
font-size:150%;
background-color:#6e8c52;

-webkit-user-select: none; /* Chrome/Safari */        
-moz-user-select: none; /* Firefox */
-ms-user-select: none; /* IE10+ */
-o-user-select: none;
user-select: none;

}
div {
background-color:none;
}
div.header {
font-family:KaufmannBold, Helvetica, Arial;
font-size:200%;
}
div.card0 {
position:absolute;
width:149px;height:149px;
background-size: cover;
border:1px solid black;
border-radius: 10px;
}
div.card1 {
position:absolute;
width:148px;height:148px;
background-size: cover;
border:2px solid red;
border-radius: 10px;
}
div.card1:hover {
border:2px solid orange;
}
div.market {
border:2px solid white;
position:relative;
width:966px;
height:330px;
background-color:#d8dec2;
overflow:hidden;
}
div.button0 {
position:absolute;
background-color:#8e8e8e;
border-radius: 7px;
color:white;
}
div.button1 {
position:absolute;
background-color:#3e6e3e;
border-radius: 7px;
color:white;
}
div.button1:hover {
background-color:#a7bc95;
color:black;
}
div.phase0 {
position:absolute;
background-color:#8e8e8e;
border-radius: 7px;
color:white;
}
div.phase1 {
position:absolute;
background-color:blue;
border-radius: 7px;
color:white;
}
</style>
<script>

// #6e8c52 - dark green background
// #d8dec2 - light green background
// #3e6e3e - dark green banner
// #a7bc95 - light green banner

// Utility functions:

function RNG(seed) {
  this.m = 0x100000000;
  this.a = 1103515245;
  this.c = 12345;
  this.state = seed === undefined ? Math.floor(Math.random() * (this.m-1)) : seed;
}
RNG.prototype.nextInt = function() {
  this.state = (this.a * this.state + this.c) % this.m;
  return this.state;
}
RNG.prototype.nextFloat = function() {
  return this.nextInt() / (this.m - 1);
}
RNG.prototype.nextRange = function(start, end) {
  var rangeSize = end - start;
  var randomUnder1 = this.nextInt() / this.m;
  return start + Math.floor(randomUnder1 * rangeSize);
}
RNG.prototype.choice = function(array) {
  return array[this.nextRange(0, array.length)];
}
Array.prototype.shuffle = function() {
    var len = this.length;
    var i = len;
    while (i--) {
	var p = rand.nextRange(0,len);
	var t = this[i];
	this[i] = this[p];
	this[p] = t;
    }
};
Array.prototype.extract = function(x) {
    var len = this.length;
    var res = [];
    for (var i = 0; i < x.length; i++) {
	var t = x[i];
	var p = this.indexOf(t);
	if (p < 0) continue;
	res.push(this.splice(p,1)[0]);
    }
    return res;
};

// TODO
// Pass all special action
// Debug mode display
//*X Promo cards
// Save ui settings
// GFX
// - remove stack blink
// - Espionage
// Start screen
// - layout
// - region randomizer
// Calculator
// Rules
// Languages

// Game constants

var regionsno = [ null, null, 3, 3, 4, 5, 5];
var maxplantsno = [ null, null, 4, 3, 3, 3, 3];
var bigcitiesno = [ null, null, 24, 24, 32, 40, 42];
var toremove = [ null, null, 8, 8, 4, 0, 0];
var limits = [ null, null, [10,21], [7,17], [7,17], [7,15], [6,14]];
var limitsbig = [ null, null, [12,24], [8,20], [8,20], [8,18], [7,15]];
var limitsbad = [ null, null, [9,21], [6,17], [6,17], [6,15], [5,14]];
var decks = [
{ id: 'S', name: 'Standard Deck' },
{ id: 'N', name: 'New Deck' },
{ id: 'M', name: 'Mixed Deck'},
{ id: 'B', name: 'Big Game Deck' },
];
var ukregions = [ 'Ireland', 'Northern Ireland', 'Scotland', 'Wales', 'Southern England', 'Northern England' ];
var ukcities = [ 7, 5, 7, 6, 8, 7 ];
var neregions = [ 'Denmark', 'Norway', 'Southern Sweden', 'Northern Sweden', 'Finland', 'Baltic States' ];
var std0 = [3,4,3,4,5,3,5,6,4,5,7,5,7,9,6];
var std1 = [2,2,4,2,3,4,3,4,5,4,5,6,5,6,7];
var std2 = [1,2,3,1,2,3,2,3,4,3,3,5,3,5,6];
var std3 = [1,1,1,1,1,1,1,2,2,2,3,2,2,3,3];
var stdrefill = [std0,std1,std2,std3];
var iberefill = [[3,4,2,4,5,2,4,6,3,4,7,3,6,8,4],[2,3,5,2,4,5,3,5,6,4,6,7,5,7,9],std2,[0,2,1,0,2,1,0,4,1,0,5,1,0,5,2]];
var ceurefill = [[4,5,3,5,6,3,6,7,5,7,8,5,8,10,6],[1,2,3,2,2,3,2,3,4,3,4,5,4,5,6],[1,3,3,1,3,3,2,4,4,3,4,5,3,6,6],[1,1,1,1,1,1,1,2,1,2,2,2,2,3,2]];
var querefill = [[3,3,3,4,4,3,5,4,4,5,5,5,7,6,6],[2,2,3,2,3,3,3,4,4,4,5,4,5,6,5],std2,std3];
var bnxrefill = [std1,std0,std2,std3];
var rusrefill = [std1,[3,4,3,3,4,3,5,6,4,5,7,5,7,9,6],[2,2,3,2,2,3,3,3,4,4,3,5,4,5,6],std3];
var gbrrefill = [[3,4,3,3,5,3,4,6,4,4,7,5,6,8,6],[2,3,2,2,4,2,3,5,3,4,6,6,5,7,5],[1,2,2,1,2,2,2,3,3,3,3,5,3,5,5],[1,1,1,1,2,1,1,3,1,2,4,2,2,4,3]];
var chnrefill = [[4,4,3,5,5,3,6,6,4,7,7,5,9,9,6],[2,2,4,3,3,4,4,4,5,5,5,6,6,6,7],[2,2,1,2,2,1,3,3,2,3,3,3,5,5,3],[1,1,1,1,1,1,2,2,2,3,3,2,3,3,3]];
var brarefill = [std2,std0,std1,std3];
var neurefill = [[2,4,3,2,4,4,4,5,5,4,5,6,6,8,5],[1,2,3,2,2,3,2,3,4,3,4,5,4,5,6],std2,[1,2,2,1,2,2,2,3,2,2,4,3,2,4,4]];
var korrefill = [[12,22,12,22,23,12,23,33,22,23,34,23,34,45,33],[11,11,13,11,12,13,12,13,23,13,23,24,23,24,34],[1,11,12,1,11,12,11,12,22,12,12,23,12,23,33],std3];

var maps = [
{ id: 'GER', name: 'Germany', startcost: [1,3,7,14], refill: stdrefill},
{ id: 'USA', name: 'USA', startcost: [1,3,7,14], refill: stdrefill },
{ id: 'ITA', name: 'Italy', startcost: [3,4,5,14], refill: stdrefill },
{ id: 'FRA', name: 'France', startcost: [1,3,7,5], refill: stdrefill },
{ id: 'CEU', name: 'Central Europe', startcost: [1,3,7,8], refill: ceurefill },
{ id: 'BNX', name: 'Benelux', startcost: [3,1,7,14], refill: bnxrefill },
{ id: 'KOR', name: 'Korea', startcost: [1,3,7,14], refill: korrefill },
{ id: 'CHN', name: 'China', nodecks: 'MBP', startcost: [5,5,7,'-'], refill: chnrefill },
{ id: 'BRA', name: 'Brazil', startcost: [1,3,7,14], refill: brarefill },
{ id: 'IBE', name: 'Spain & Portugal', startcost: [1,3,6,5], refill: iberefill },
{ id: 'JPN', name: 'Japan', nodecks: 'B', startcost: [2,4,6,12], refill: stdrefill },
{ id: 'RUS', name: 'Russia', nodecks: 'M', startcost: [3,1,'-',6], refill: rusrefill },
{ id: 'QUE', name: 'Quebec', startcost: [2,2,7,14], refill: querefill },
{ id: 'BAD', name: 'Baden-Wuerttemberg', nodecks: 'B', startcost: [1,3,7,14], refill: stdrefill },
{ id: 'GBR', name: 'UK & Ireland', regions: ukregions, cities: ukcities, startcost: [1,3,5,'-'], refill:gbrrefill },
{ id: 'NEU', name: 'Northern Europe', nodecks: 'MB', regions: neregions, startcost: [3,3,5,7], refill:neurefill },
];
var plants =    [ '03A','04A','05A','06A','07A','08A','09A','10A','11A','12A','13A','14A','15A',
                  '16A','17A','18A','19A','20A','21A','22A','23A','24A','25A','26A','27A','28A',
                  '29A','30A','31A','32A','33A','34A','35A','36A','37A','38A','39A','40A',
                  '42A','44A','46A','50A' ];
var newplants = [ '01B','02B','03B','04B','05B','06B','07B','08B','09B','10B','11B','12B','13B',
                  '14B','15B','16B','19B','20B','21B','22B','23B','24B','25B','26B','27B','28B',
                  '29B','30B','31B','32B','33B','34B','35B','36B','37B','38B','39B','40B',
                  '42B','44B','46B','50B' ];
var bigplants = [ '52B','54B','57B','60B' ];
var step3 = '999';

var topdeckplants = [ '13A', '11B' ];
var ecoplants = [ '13A','18A','22A','27A','33A','37A','44A',
                  '10B','11B','15B','16B','26B','32B','39B' ];
var gasplants = [ '06A','14A','19A','24A','30A','38A',
                  '06B','21B','27B','33B','42B','52B' ];
var neplants = [
    [ [ '19A', '26A', '22B', '27B' ], [ '19C', '26C' ]],
    [ [ '07A', '46A', '07B', '36B' ], [ '07C', '46C' ]],
    [ [ '10A', '39A', '09B', '38B' ], [ '10C', '39C' ]],
    [ [ '21A', '25A', '28B', '29B' ], [ '21C', '25C' ]],
    [ [ '32A', '44A', '25B', '39B' ], [ '32C', '44C' ]],
    [ [ '18A', '22A', '15B', '16B' ], [ '18C', '22C' ]],
];

var promos = [
{ name: 'Flux-Generator', val: 6, card: '33D' },
{ name: 'Transformer Station', val: 7, card: 'X01' },
{ name: 'Warehouse', val: 8, card: 'X02' },
{ name: 'Shortage of Resources', val: 9, card: 'X03' },
{ name: 'Surplus of Resources', val: 10, card: 'X04' },
{ name: 'Theme Park', val: 11, card: 'X05' },
{ name: 'Supply Contract', val: 12, card: 'X06' },
{ name: 'Industrial Espionage', val: 13 },
];

var version = 1;
// Game state

var players = 3;
var ingame = 0;
var gamelog = '';
var deck = 0; // 0-classic, 1-new, 2-mix (variant 2), 3-big (variant 3)
var map = 0;
var options = 0; // bitmask: 0-5, regions for GBR, NEU; 6+ promos

// UI state

var alttable = 0;

function set_state(s) {
    if (!s) return;
    var state = s.split(',');
    if (state[0] != version) {
	alert('Ignoring old game state');
	return;
    }
    ingame = parseInt(state[1]);
    players = parseInt(state[2]);
    deck = parseInt(state[3]);
    map = parseInt(state[4]);
    options = parseInt(state[5]);
    gamelog = state[6];
    if (gamelog) init_game(gamelog);
}
function get_state() {
    return [version,ingame,players,deck,map,options,gamelog].join(',');
}    

var storage = sessionStorage;
function load_state() {
    set_state(storage.getItem('state'));
}
function save_state() {
    storage.setItem('state',get_state());
}

function deck_id() { return decks[deck].id; }
function map_id() { return maps[map].id; }
function plant_val(a) { return parseInt(a,10); }
function get_limits() {
    if ('B' == deck_id()) return limitsbig[players];
    if ('BAD' == map_id()) return limitsbad[players];
    if ('GBR' == map_id() && players == 2) {
	var c = 0;
	if (chosen_regions() == regionsno[players]) {
	    for (var i = 0; i < 6; i++) if (has_option(i)) c += ukcities[i];
	} else {
	    c = 'x';
	}
	return [limits[2][0],c];
    }
    return limits[players];
}
function has_option(v) {
    return options & (1 << v);
}
function chosen_regions() {
    var ret = 0;
    for (var i = 0; i < 6; i++) if (has_option(i)) ret++;
    return ret;
}
function has_espionage() { return has_option(13); }

function mixplants() {
    var tmp = plants.concat(newplants);
    var ret = [];
    var have = {};
    tmp.shuffle();
    for(var i = 0; i < tmp.length; i++) {
	var val = plant_val(tmp[i]);
	if (!have[val] && val != 17 && val != 18) {
	    ret.push(tmp[i]);
	}
	have[val] = 1;
    }
    ret.sort();
    return ret;
}

function init_deck() {
    var p = plants;
    var remove = toremove[players];
    marketsize = 4; // for Russia
    if ('N' == deck_id()) p = newplants;
    if ('M' == deck_id()) p = mixplants();
    if ('B' == deck_id()) {
	p = p.concat(bigplants, newplants.slice(-2));
	remove = remove / 4 * 5;
    }

    stack = p.slice(0);
    if ('RUS' == map_id()) {
	stack.extract(['06A','14A','06B','21B'])
	marketsize = 3;
    } else if ('CHN' == map_id()) {
	stack.extract(['03A','04A','33A','01B','02B','32B']);
	if (players < 5)
	    stack.extract(['11A','18A','24A','46A','08B','15B','27B','36B']);
	if (players < 4)
	    stack.extract(['09A','16A','20A','30A','12B','22B','28B','42B']);
	market = stack.splice(0,players);
	var pos = stack.indexOf('S' == deck_id()?'31A':'30B');
	var tmp1 = stack.splice(pos);
	pos = tmp1.indexOf('S' == deck_id()?'36A':'35B');
	var tmp2 = tmp1.splice(pos);
	tmp1.push(step3);
	tmp1.shuffle();
	tmp2.shuffle();
	stack = stack.concat(tmp1,tmp2);
	return;
    } else if ('NEU' == map_id()) {
	for (var i = 0; i < 6; i++) if (has_option(i)) {
	    stack.extract(neplants[i][0]);
	    stack = stack.concat(neplants[i][1]);
	}
	stack.sort();
    }
    market = stack.splice(0,marketsize * 2);

    var topdeck = [];
    var bottomdeck = [];
    if ('M' != deck_id()) {
	topdeck = stack.extract(topdeckplants);
	if ('FRA' == map_id()) {
	    topdeck = stack.extract(['11A','19B']);
	} else if ('BRA' == map_id()) {
	    topdeck = topdeck.concat(stack.extract(['14A','21B']));
	} else if ('IBE' == map_id()) {
	    step2plants = stack.extract(['18A','22A','27A','15B','16B','26B']);
	} else if ('RUS' == map_id()) {
	    var tmp = stack.extract(['10A','11A','08B','09B']);
	    stack.shuffle();    
	    tmp = tmp.concat(stack.splice(-3));
	    tmp.shuffle();
	    topdeck = topdeck.concat(tmp);
	} else if ('QUE' == map_id()) {
	    topdeck = topdeck.concat(stack.extract(['18A','22A','15B','16B']));
	}
    }
    if ('GBR' == map_id()) {
	stack.shuffle();
	bottomdeck = stack.splice(-2);
    }
    if (remove) {
	var save;
	if ('BRA' == map_id()) save = stack.extract(gasplants);
	if ('QUE' == map_id()) save = stack.extract(ecoplants);
	stack.shuffle();
	stack.splice(-remove);
	if (save) {
	    stack = stack.concat(save);
	}
    }
    for (var i = 0; i < promos.length; i++) if (has_option(promos[i].val) && promos[i].card) {
	stack.push(promos[i].card);
    }
    stack.shuffle();
    stack = topdeck.concat(stack,[step3],bottomdeck);
}

function init_game(state) {
    var oldlog = '';
    market = [];
    phase = 2; // 2->4->5
    step = 1;
    turn = 1;
    stack = [];
    houses = 0;
    playersleft = players;
    sold = 0;
    step2plants = undefined; // for Spain & Portugal
    log_clear();
    if (state) {
	state = state.split('|');
	rand = new RNG(parseInt(state[0]));
	oldlog = state[1];
    } else {
	rand = new RNG();
    }
    log_append(rand.state + '|');
    init_deck();
    if ('B' == deck_id()) {
	cities = bigcitiesno[players];
    } else if (maps[map].cities) {
	cities = 0;
	for (var i = 0; i < 6; i++) if (has_option(i)) {
	    cities += maps[map].cities[i];
	}
    } else {
	cities = regionsno[players] * 7;
    }
    ui_init_game();
    replay(oldlog);
    flush_events();
}

// State variables modifiers
function log_clear() {
    gamelog = '';
    save_state();
}
function log_append(a) {
    gamelog += a;
    save_state();
}
function set_players(n) {
    players = n;
    save_state();
}
function set_deck(v) {
    deck = v;
    save_state();
}
function set_map(v) {
    if (map == v) return;
    for (var i = 0; i < 6; i++)
	set_option(i, 0);
    if(maps[v].nodecks && maps[v].nodecks.search('P') >= 0) {
	for (var i = 0; i < promos.length; i++)
	    set_option(promos[i].val, 0);
    }
    if(maps[v].nodecks && maps[v].nodecks.search(deck_id()) >= 0)
	set_deck(0);
    map = v;
    save_state();
}
function set_option(o,v) {
    if (v) {
	options |= 1 << o;
    } else {
	options &= ~(1 << o);
    }
    save_state();
}
function set_ingame(v) {
    ingame = v;
    save_state();
}
function replay(inlog) {
    for (var i = 0; i < inlog.length; i++) {
	var c = inlog.substr(i, 1);
	switch (c) {
	    case 'B': do_build(); break;
	    case 'E': do_endbuild(); break;
	    case 'T': do_endturn(); break;
	    case 'P': do_pass(); break;
	    case 'N': do_nospace(); break;
	    default: do_buy(parseInt(c)); break;
	}
    }
}


// Market/stack manipulation:
function market_remove(i) {
    { // DISPLAYEVENT
    var ev = {};
    ev[market[i]] = [ 2.5, 2.5, 3];
    mvqueue.push(ev);
    }
    market.splice(i,1);
}
function market_shift() {
    market_remove(0);
}
function market_pop() {
    market_remove(market.length - 1);
    // DISPLAYEVENT
    {
    var ev = {};
    for (var i = 0; i < market.length; i++) {
	ev[market[i]] = [ i, 0, 3];
    }
    mvqueue.push(ev);
    }
}
function market_to_stack(i) {
    if (i < 0) i = market.length - 1;
    { // DISPLAYEVENT
    var ev = {};
	ev[market[i]] = [5,1, 1];
    mvqueue.push(ev);	
    }
    stack.push(market.splice(i,1)[0]);
}

function draw() {
    if (!stack.length) return;
    var plant = stack.shift();
    if (plant == step3) {
	stack.shuffle(); // skip this for China?
    }
    if (plant.substr(0,1) == 'X') {
	draw();
	return;
    }
    market.push(plant);
    market.sort();
    // DISPLAYEVENT
    {
    var ev1 = {}, ev2 = {};
    for (var i = 0; i < market.length; i++) {
	var m = market_availiable();
	var newpos = [ i % m, i >= m, market[i] != plant ? 3 : 4];
	ev1[market[i]] = market[i] != plant ? newpos : [5, 1, 3];
	ev2[market[i]] = newpos;
    }
    mvqueue.push(ev1);
    mvqueue.push(ev2);
    }
    if ('BAD' != map_id() && 'RUS' != map_id() && 'CHN' != map_id())
    if(houses >= plant_val(market[0])) {
          market_shift();
          draw();
    }
}

function step2() {
    if (step2plants)
	stack = step2plants.concat(stack);
    market_shift();
    draw();
    step = 2;
    test_step3();
}

function test_step3() {
    if (market.indexOf(step3) < 0) return;
    step = 3;
    market_shift();
    market_pop();
    if ('CHN' == map_id()) while(market.length < 4) draw();
}

function do_buy(i) {
    log_append(i);
    playersleft--;
    sold = 1;
    market_remove(i);
    if ('CHN' != map_id() || step == 3)
	draw();
    if (!playersleft) {
        test_step3();
        phase = 4;
    }
}

function do_pass() {
    log_append('P');
    playersleft--;
    if ('RUS' == map_id()) {
	market_shift();
	draw();
    }
    if (!playersleft) {
        if (!sold && 'RUS' != map_id() && 'CHN' != map_id()) {
            market_shift();
            draw();
	    if ('BAD' == map_id()) {
		market_shift();
		draw();
	    }
        }
        test_step3();
        phase = 4;
    }
}
function do_build() {
    log_append('B');
    houses++;
    if ('BAD' != map_id() && 'RUS' != map_id() && 'CHN' != map_id())
    while(houses >= plant_val(market[0])) {
        market_shift();
        draw();
    }
}
function do_endbuild() {
    var lim = get_limits();
    log_append('E');
    test_step3();
    if (houses >= lim[0] && step == 1) {
	step2();
    }
    if (houses >= lim[1]) {
        step = 0;
    }
    phase = 5;
}
function do_nospace() {
    log_append('N');
    step2();
    phase = 5;
}
function do_endturn() {
    log_append('T');
    if (step < 3) {
	if ('CHN' == map_id()) {
	    var d = [0,0,2,2,3,4,5][players];
	    var m = [0,0,1,1,2,2,3][players];
	    var i = d - market.length;
	    if (i < m) i = m;
	    while (i--) {
		draw();
		if (market.indexOf(step3) >= 0) break;
		if (market.length > d) market_shift();
	    }
	} else if ('QUE' == map_id()) {
	    var i;
	    for (i = market.length - 1; i >= 0; i--) {
		if (ecoplants.indexOf(market[i]) < 0) break;
	    }
	    market_to_stack(i);
	    draw();
	} else if ('BNX' == map_id()) {
	    market_to_stack(-1);
	    market_shift();
	    draw();
	    draw();
	} else {
	    market_to_stack(-1);
	    draw();
	}
        test_step3();
    } else if (market.length > 0) {
        market_shift();
        draw();
    }
    turn++;
    phase = 2;
    sold = 0;
    playersleft = players;
}

function market_availiable() {
    var ret = market.length;
    if (step < 3 && 'CHN' != map_id() && ret > marketsize) {
	ret = marketsize;
	if ('BNX' == map_id() && ecoplants.indexOf(market[ret]) >= 0)
	    ret++;
    }
    return ret;
}
function nospace_active() {
    return step == 1 && phase == 4 && players * houses >= cities && houses < get_limits()[0];
}

function undo_active() {
    return gamelog.substr(-1) != '|';
}
function nextphase_active() {
    if (phase == 2 && turn == 1) return 0;
    return step > 0;
}

function region_select() {
    return maps[map].regions && 'B' != deck_id();
}
function pass_active() {
    return phase == 2 && turn > 1 && 'RUS' == map_id();
}
// User intrerface functions

function buy(i) {
    if (market_availiable() > i && phase == 2) {
	flush_events();
        do_buy(i);
    }
    display();
}
function pass() {
    if (phase == 2 && turn > 1) {
	flush_events();
        do_pass();
    }
    display();
}
function passall() {
    while (phase == 2 && turn > 1) {
	flush_events();
        do_pass();
    }
    display();
}
function build() {
    if (phase == 4) {
	flush_events();
        do_build();
    }
    display();
}
function nospace() {
    if (phase == 4 && step == 1) {
	flush_events();
        do_nospace();
    }
    display();
}
function endbuild() {
    if (phase == 4) {
	flush_events();
        do_endbuild();
    }
    display();
}
function endturn() {
    if (phase == 5 && step > 0) {
	flush_events();
        do_endturn();
    }
    display();
}
function nextphase() {
    if (phase == 2) {
	passall();
    } else if (phase == 4) {
	endbuild();
    } else if (phase == 5) {
	endturn();
    }
}
function start_game() {
    set_ingame(1);
    init_game();
    display();
}

function end_game() {
    if (!step || confirm('Exit game?'))
	set_ingame(0);
    display();
}

function undo() {
    init_game(gamelog.substr(0,gamelog.length-1));
    display();
}

function report_mail() {
    var ret = 'mailto:reports@pgm.org';
    ret += '?subject=Online report';
    ret += '&body=Keep this line:%0d';
    ret += get_state();
    if (navigator) ret += ' / ' + navigator.userAgent;
    return ret;
}

// User interface

document.onkeydown = function(e) {
    if (!ingame) return;
    if (e.keyCode > 48 && e.keyCode < 55) {
        if (phase == 2) {
            buy(e.which - 49);
        } else if (phase == 4) {
            for (var i = 48; i < e.keyCode; i++)
                build();
        }
        return false;
    } else if (e.ctrlKey && e.keyCode == 90 && undo_active()) {
        undo();
    } else if (e.keyCode == 78) {
	nextphase();
    } else if (e.keyCode == 27) {
        end_game();
    }
}

function ui_set_regions(elem) {
    for (var i = 0; i < 6; i++) {
	set_option(i, elem.options[i].selected);
    }
    display();
}

function ui_set_pos(name,x,y,z) {
    var px = Math.round(10 + 160 * x);
    var py = Math.round(10 + 160 * y);
    var item = document.getElementById("card"+name);
    if (!item) return;
    item.style.left = px + 'px';
    item.style.top = py + 'px';
    item.style.zIndex = z;
}

var lastpos = {};

function ui_card(name,forsale,topstack) {
    var px = 10 + 160 * lastpos[name][0];
    var py = 10 + 160 * lastpos[name][1];
    var ret ='';
    ret += '<div class="card'+(forsale >=0 ? 1:0)+'" style="';
    ret += 'background: url(img/'+name+'.jpg);';
    ret += 'background-size: cover;'
    ret += 'top:'+py+'px;left:'+px+'px;"';
    if (topstack)
	ret += 'z-index:1;"';
    ret += ' id="card' + name + '"';
    if (forsale >= 0) ret += ' onClick="buy('+forsale+')"';
    ret += '>';
//    ret += name;
    ret += '</div>';
    return ret;
}
function ui_stack() {
    var px = 10 + 160 * 5;
    var py = 10 + 160 * 1;
    var ret ='';
    ret += '<div class="card0" style="'
    ret += 'background: url(img/DEC.jpg);';
    ret += 'background-size: cover;'
    ret += 'z-index:2;';
    ret += 'top:'+py+'px;left:'+px+'px;"';
    ret += ' id="cardTOP"';
    ret += '>';
    ret += '</div>';
    return ret;
}

function ui_alttable() {
    alttable = !alttable;
    display();
}

function ui_step() {
    var px = 10 + 160 * 4;
    var py = 10 + 160 * 1;
    var alt = alttable;
    var ret ='';
    ret += '<div style="position:absolute;background-color:none;width:150px;height:150px;'
    ret += 'border:0px solid black;z-index:0;text-align:center;';
    ret += 'top:'+py+'px;left:'+px+'px;" onClick="ui_alttable()">';
    if (!alt) ret += '<div style="font-size:150%">'+(step?'Step '+step:'Game over')+'</div>';
    ret += '<table align="center">';
    if (!alt) {
    ret += '<tr>';
    for (var i = 1; i <= 4; i++) {
	ret += '<td width="25" height="40">';
	ret += '<img src="img/R'+i+'.png" height="31">';
	ret += '</td>';
    }
    ret += '</tr>';
    }
    for (var s = 1; s <= 3; s++) if (s == step || alt) {
	var rows = 'KOR' == map_id() ? 2:1;
	var h = rows == 2 ? 20 : 40;
	for (var j = 0; j < rows; j++) {
	    ret += '</tr>';
	    for (var i = 1; i <= 4; i++) {
		var bgcol = s == step ? (i%2?'3e6e3e':'a7bc95') : (i%2?'4e4e4e':'a8a8a8');
		var fgcol = (i%2?'white':'black');
		var cost = maps[map].refill[i-1][s-1+(players-2)*3];
		if (rows > 1) cost = j ? cost % 10 : Math.floor(cost / 10);
		ret += '<td width="25" height="'+h+'" style="background-color:#'+bgcol+';color:'+fgcol+';">';
		ret += '<div style="max-height:'+h+'px;line-height:'+h+'px;">'
		ret += cost;
		ret += '</div></td>';
	    }
	    ret += '</tr>';
	}
    }
    ret += '</table>';
    ret += '</div>';
    return ret;
}
function ui_button(x,y,w,h,name,func) {
	var ret = '';
	x++; y++; w-=2; h-=2;
	ret += '<div class="button'+(func?1:0)+'" style="line-height:'+h+'px;left:'+x+'px;top:'+y+'px;width:'+w+'px;height:'+h+'px;"';
	ret += ' onClick="'+func+'()"';
	ret += '>';
	ret += name;
	ret += '</div>';
	return ret;
}

function ui_phase(x,y,w,h,name,on) {
	var ret = '';
	x++; y++; w-=2; h-=2;
	ret += '<div class="phase'+(on?1:0)+'" style="line-height:'+h+'px;left:'+x+'px;top:'+y+'px;width:'+w+'px;height:'+h+'px;">';
	ret += name;
	ret += '</div>';
	return ret;
}

function ui_market() {
    var ret = '<div class="market">';
    var m = market_availiable();
    for (var i = 0; i < m; i++) ret += ui_card(market[i], phase == 2 ? i : -1, 0);
    for (var i = m; i < market.length; i++) ret += ui_card(market[i], -1, 0);
    for (var i = 0; i < stack.length && i < 4; i++) ret += ui_card(stack[i], -1, i == 0);
    var p = event_cards();
    for (var i = 0; i < p.length; i++) {
	var sp = stack.indexOf(p[i]);
	if (market.indexOf(p[i]) == -1 && (sp >= 4 || sp == -1))
	    ret += ui_card(p[i], -1, 0);
    }
//    for (var i in lastpos) {
//	var c = phase == 2 ? market.indexOf(i) : -1;
//	if (c >= m) c = -1;
//	ret += ui_card(i, c, stack.length && i == stack[0]);
//    }
    if (stack.length > 0)
	ret += ui_stack();
    ret += ui_step();
    ret += '</div>';
    ret += '\n';
    ret += '<div style="position:relative;width:970px;height:36px;">';
    var lim = get_limits();
    for (i = 0; i < cities && i < 24; i++) {
	var bg = 'a';
	if (i == lim[0] - 1) bg = '2';
	if (i == lim[1] - 1) bg = '2';
	if (houses > i) bg = '3';
	ret += '<div style="line-height:35px;position:absolute;left:'+i*35+'px;width:35px;height:35px;background: url(img/house'+bg+'.png);background-size: cover;">';
	ret += i + 1;
	ret += '</div>';
    }
    ret += ui_button(900,0,70,35,'Build',phase == 4?'build':'');
    ret += '</div>';
    ret += '\n';
    ret += '<div style="position:relative;width:970px;height:72px;">';
    for (i = 0; i < 5; i++) {
	var phasenames = ['Player order','Auction','Resources','Building','Bureaucracy'];
	var name = phasenames[i];
	var bg = 0;
	var order = i;
	if (i == phase - 1) {
	    bg = 1;
	    if (phase == 2) {
		name += ': ' + (players - playersleft + 1) + '/' + players;
	    }
	}
	if (order < 2 && (turn == 1 || 'BAD' == map_id())) order ^= 1;
	ret += ui_phase(order*168,0,168,35,name,bg);
    }
    if (pass_active()) {
	ret += ui_button(1*168,35,168,35,'Pass','pass');
    }
    if (nospace_active()) {
	ret += ui_button(3*168,35,168,35,'Out of space','nospace');
    }

    ret += ui_button(900,0,70,35,'Next',nextphase_active()?'nextphase':'');
    ret += ui_button(900,35,70,35,'Undo',undo_active()?'undo':'');
    ret += ui_button(0,35,100,35,'End game','end_game');

    ret += '</div>';
    return ret;
}

function ui_init_game() {
    var m = market_availiable();
    lastpos = {};
    mvqueue = [];
    for (var i = 0; i < m; i++) lastpos[market[i]] = [i, 0];
    for (var i = m; i < market.length; i++) lastpos[market[i]] = [i-m, 1];
    for (var i = 0; i < stack.length; i++) lastpos[stack[i]] = [5, 1];
    if (step2plants)
	for (var i = 0; i < step2plants.length; i++) lastpos[step2plants[i]] = [5, 1];
}

function display() {
    if (ingame) {
	var m = market_availiable();
	var tmp = '';
	tmp += '<div class="header">'+maps[map].name+', '+players+' Players</div>';
	tmp += ui_market();
//	tmp += 'Market: ' + market.slice(0,m).toString() + '<br/>';
//	tmp += 'Future Market: ' + market.slice(m).toString() + '<br/>';
//	tmp += 'Connected cities: ' + houses + ' ';
//	tmp += 'Step: ' + step + ' ';
//	tmp += 'Turn: ' + turn + ' ';
//	tmp += 'Phase: ' + phase + ' ';
//	tmp += 'Left: ' + playersleft + '<br/>';
//	tmp += 'Stack: ' + stack.toString() + '<br/>';
//	tmp += 'Log: ' + gamelog + '<br/>';

	if (phase == 2) {
//	    for (var i = 0; i < market_availiable(); i++)
//	    tmp += '<button type="button" onclick="buy('+i+')">Buy '+i+'</button>';
	    if (turn > 1) {
//		if (pass_active())
//		    tmp += '<button type="button" onclick="pass()">Pass</button>';
//		tmp += '<button type="button" onclick="passall()">Pass All</button>';
	    }
	}
	if (phase == 4) {
//	    tmp += '<button type="button" onclick="build()">Build</button>';
	    if (nospace_active()) {
//		tmp += '<button type="button" onclick="nospace()">Out of Space</button>';
	    }
//	    tmp += '<button type="button" onclick="endbuild()">End Build</button>';
	}
	if (phase == 5 && step > 0) {
//	    tmp += '<button type="button" onclick="endturn()">End Turn</button>';
	}
//	tmp += '<br/>';
//	tmp += '<button type="button" onclick="end_game()">End Game</button>';
	if (undo_active()) {
//	    tmp += '<button type="button" onclick="undo()">Undo</button>';
	}
	tmp += '<br/><a href="' + report_mail() + '"><button>Report a problem</button></a>';
	document.getElementById("buttons").innerHTML=tmp;
    } else {
	var tmp ='';
	tmp += '<div class="header">Power Grid Market Aid</div>';
	tmp += '<select id="playersno" onChange="set_players(document.getElementById(\'playersno\').value);display();">';
	for(var i = 2; i <= 6; i++) {
	    tmp += '<option value="'+i+'"';
	    if (i == players) tmp += ' selected';
	    tmp += '>'+i+' Players</option>';
	}
	tmp += '</select>';
	tmp += '<select id="mapno" onChange="set_map(this.value);display();">';
	for(var i = 0; i < maps.length; i++) {
	    tmp += '<option value="'+i+'"';
	    if (i == map) tmp += ' selected';
	    tmp += '>'+maps[i].name+'</option>';
	}
	tmp += '</select>';
	tmp += '<select id="deckno" onChange="set_deck(this.value);display();">';
	for(var i = 0; i < decks.length; i++) {
	    if (maps[map].nodecks && maps[map].nodecks.search(decks[i].id) >= 0) continue;
	    tmp += '<option value="'+i+'"';
	    if (i == deck) tmp += ' selected';
	    tmp += '>'+decks[i].name+'</option>';
	}
	tmp += '</select>';
	tmp += '<br/>';
	tmp += '<div style="position:relative;width:970px;height:600px;">';
	tmp += '<div class="market" style="position:absolute;top:30px;left:660px;text-align:left;height:250px;width:300px;">';
	if (region_select()) {
	    for(var i = 0; i < 6; i++) {
		tmp += '<input type="checkbox" onChange="set_option('+i+',this.checked);display();"';
		if (has_option(i)) tmp += ' checked';
		tmp += '>'+maps[map].regions[i]+'</input>';
	    tmp += '<br/>';
	    }
	}
	tmp += '</div>';
	tmp += '<div class="market" style="position:absolute;top:30px;left:0px;text-align:left;font-size:80%;height:250px;width:300px;">';
	if (!maps[map].nodecks || maps[map].nodecks.search('P') < 0) {
	    for(var i = 0; i < promos.length; i++) {
		tmp += '<input type="checkbox" onChange="set_option('+promos[i].val+',this.checked);display();"';
		if (has_option(promos[i].val)) tmp += ' checked';
		tmp += '>'+promos[i].name+'</input>';
	    tmp += '<br/>';
	    }
	}
	tmp += '</div>';
	var lim = get_limits();
	tmp += '<div class="market" style="position:absolute;top:30px;left:330px;height:250px;width:300px;"><table>';
	if (deck_id() == 'B') {
	    tmp += ui_info('Number of cities chosen on map',bigcitiesno[players]);
	} else {
	    var value = regionsno[players];
	    if (region_select()) {
		var diff = regionsno[players] - chosen_regions();
		if (!diff) value += ' OK';
		else if (diff > 0) value += ' (' + diff + ' more)';
		else value += ' (' + -diff + ' less)';
	    }
	    tmp += ui_info('Number of regions chosen on map',value);
	}
	tmp += ui_info('Maximum number of power plants owned',maxplantsno[players]);
	tmp += ui_info('Number of connected cities to trigger step 2 / game end',lim.join(' / '));
	tmp += ui_info('Starting money',50);
	tmp += ui_info('Initial resource costs',maps[map].startcost.join(', '));
	tmp += '</table></div>';
	if (region_select() && regionsno[players] != chosen_regions())
	    tmp += '<button disabled type="button" onclick="start_game()">New Game</button>';
	else
	    tmp += '<button type="button" onclick="start_game()">New Game</button>';
	tmp += '</div>';
	document.getElementById("buttons").innerHTML=tmp;
    }
}
function ui_info(name,value) {
    var ret = '<tr><td style="text-align:right;line-height:16px;width:200px;font-size:70%">';
    ret += name + '</td><td style="width:100px;line-height:42px;background-color:#a7bc95;">';
    ret += value + '</td></tr>';
    return ret;
}
var frames = 25;
var mvqueue = [];
function display_event() {
    setTimeout('display_event()', 1000/25);
    if (!ingame) return;
    var curmv = mvqueue[0];
    if (!curmv) return;
    for (var c in curmv) {
	var src = lastpos[c];
	var dst = curmv[c];
	var xz = frames/25;
	var px = src[0]*xz + dst[0]*(1-xz);
	var py = src[1]*xz + dst[1]*(1-xz);
	ui_set_pos(c,px,py,frames>0?dst[2]:0);
    }
    frames--;
    if (frames < 0) {
	for (var c in curmv)
	    lastpos[c] = curmv[c];
	mvqueue.shift();
	frames = 25;
    }
}
function flush_events() {
    var e;
    while (e = mvqueue.shift())
	for (var c in e)
	    lastpos[c] = e[c];
    frames = 25;
}
function event_cards() {
    var r = [];
    for (var i = 0; i < mvqueue.length; i++)
	for (var c in mvqueue[i])
	    if (r.indexOf(c) == -1)
		r.push(c);
    return r;
}
</script>
</head>
<body onLoad="load_state();display();display_event();">
<div id="buttons">Loading...</div>
</body>
</html> 
